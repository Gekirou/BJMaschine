package de.cfc.bjm;

import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;

import android.app.Activity;
import android.content.Intent;
import android.graphics.Bitmap;
import android.graphics.BitmapFactory;
import android.graphics.Matrix;
import android.net.Uri;
import android.os.Bundle;
import android.os.Environment;
import android.provider.MediaStore;
import android.view.View;
import android.view.View.OnClickListener;
import android.widget.AdapterView;
import android.widget.Button;
import android.widget.GridView;
import android.widget.AdapterView.OnItemClickListener;
import de.cfc.bjm.data.ImageAdapter;


public class ImageSelector extends Activity{

	Button foto;
	String avatar;
	File imageFolder;
	File photo;

	
public void onCreate(Bundle savedInstanceState) {
    super.onCreate(savedInstanceState);
    setContentView(R.layout.gridview);
    GridView gridview = (GridView) findViewById(R.id.gridview);
    gridview.setAdapter(new ImageAdapter(this));

    gridview.setOnItemClickListener(new OnItemClickListener() {
        public void onItemClick(AdapterView<?> parent, View v, int position, long id) {
            switch (position){
            case 0:
            	avatar="conan.jpg";
            	break;
            case 1:
            	avatar="bier.jpg";
            	break;
            case 2:
            	avatar="corpsstudent.jpg";
            	break;
            case 3:
            	avatar="anonym.jpg";
            	break;
            case 4:
            	avatar="hendrix.jpg";
            	break;
            case 5:
            	avatar="spongebob.jpg";
            	break;
            default:
            	avatar="anonym.jpg";
            	break;
            }
            final Intent i = new Intent();
            i.putExtra("avatar", avatar);
            setResult(RESULT_OK, i);
            finish();
        }
    });
    
    foto = (Button) findViewById(R.id.take_photo);
    foto.setOnClickListener(new OnClickListener() {
		
		public void onClick(View v) {
			 		imageFolder = new File(
				   	   Environment.getExternalStorageDirectory(), ".bjm/avatar");
				   	   if (!imageFolder.exists()) {
				   	    imageFolder.mkdirs();
				   	   }
				   String[] size=imageFolder.list(null);
				   	photo = new File(imageFolder.getPath(), size.length+".jpg");
				   	avatar=size.length+".jpg";
				   	   if (!photo.exists()) {
				   	    try {
							photo.createNewFile();
						} catch (IOException e) {
							// TODO Auto-generated catch block
							e.printStackTrace();
						}
				   	   }
			
			        Intent imageCaptureIntent = new Intent(MediaStore.ACTION_IMAGE_CAPTURE);
			        imageCaptureIntent.putExtra(MediaStore.EXTRA_OUTPUT,  Uri.fromFile(photo));
			        startActivityForResult(imageCaptureIntent, 1);
			 }
	});
    
    
}
protected void onActivityResult(int requestCode, int resultCode, Intent data){
	if(resultCode==RESULT_OK){
	imageFolder = new File(
		   	   Environment.getExternalStorageDirectory(), ".bjm/avatar");
	 String[] size=imageFolder.list(null);	 
	Bitmap pic = BitmapFactory.decodeFile(imageFolder.getPath()+"/"+ (size.length-1)+".jpg");

		
	    int width = pic.getWidth();
	    int height = pic.getHeight();
	    Bitmap cropped=pic;
	    if(height>width){
//	    	cropped = Bitmap.createBitmap(pic,0,(height-width)/2,width,width);
	    	cropped = Bitmap.createBitmap(pic,(width-height)/2,0,height,height);
	    }else{
	    	cropped = Bitmap.createBitmap(pic,(width-height)/2,0,height,height);
	    }
	    width = cropped.getWidth();
	    height = cropped.getHeight();
	    int newWidth = 300;
	    int newHeight = 300;
	    
	    // calculate the scale - in this case = 0.4f
	    float scaleWidth = ((float) newWidth) / width;
	    float scaleHeight = ((float) newHeight) / height;
	    
	    // createa matrix for the manipulation
	    Matrix matrix = new Matrix();
	    // resize the bit map
	    matrix.postScale(scaleWidth, scaleHeight);

	    // recreate the new Bitmap
	    Bitmap resizedBitmap = Bitmap.createBitmap(cropped, 0, 0, width, height, matrix, true); 
	    try {
	        FileOutputStream out = new FileOutputStream(photo,false);
	        resizedBitmap.compress(Bitmap.CompressFormat.JPEG, 90, out);
	        out.flush();
            out.close();

            MediaStore.Images.Media.insertImage(getContentResolver(),photo.getAbsolutePath(),photo.getName(),photo.getName());
	 } catch (Exception e) {
	        e.printStackTrace();
	 }
	
	
	final Intent i = new Intent();
    i.putExtra("avatar", avatar);
    setResult(RESULT_OK, i);
    finish();
	}
}

}